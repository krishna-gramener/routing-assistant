<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† AI Insights</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Background decorative elements -->
    <div class="bg-decoration-1"></div>
    <div class="bg-decoration-2"></div>
    
    <!-- Header -->
    <div class="header">
        <button class="home-btn" id="home-btn" title="Fresh Start - Reload Page">
            <svg class="icon" viewBox="0 0 20 20">
                <path d="M10 3L2 10L4 12L10 6L16 12L18 10L10 3Z" fill="white"/>
                <path d="M4 12V17H8V13H12V17H16V12" stroke="white" stroke-width="2" fill="none"/>
            </svg>
            <span>Home</span>
        </button>
        <div class="header-title">üß† AI Insights</div>
    </div>
    

    <!-- Main content area -->
    <div class="main-content">
        <!-- Welcome screen -->
        <div class="welcome-screen" id="welcome-screen">
            <h1 class="welcome-title">‚ú® AI Insights</h1>
            <p class="welcome-subtitle">
                Get decision-ready insights through simple dialogue, compare districts, explore health trends, and uncover patterns, all powered by AI.
            </p>
            <!-- Mute the below paragraph -->
            <p class="welcome-subtitle-small">
                This demo uses select NFHS-5 data across these themes: maternal services, anaemia, child nutrition, immunisation & diarrhoea care, determinants (clean fuel), cost (out-of-pocket delivery), family planning, women‚Äôs education, and NCD risks.
            </p>
        </div>
        
        <!-- Chat area -->
        <div class="chat-area" id="chat-area"></div>
    </div>
    
    <!-- Suggestion cards -->
    <div class="suggestions" id="suggestions">
        <div class="suggestion-card" data-description="Rank the top 5 and bottom 5 districts by MMR">
            <div class="suggestion-title">District MMR Ranking</div>
            <div class="suggestion-description">Rank the top 5 and bottom 5 districts by MMR</div>
        </div>
        <div class="suggestion-card" data-description="Compare anemia prevalence in Lucknow, Gorakhpur, and Jhansi">
            <div class="suggestion-title">Regional Anemia Comparison</div>
            <div class="suggestion-description">Compare anemia prevalence in Lucknow, Gorakhpur, and Jhansi</div>
        </div>
        <div class="suggestion-card" data-description="What are the latest maternal health policies and initiatives in India?">
            <div class="suggestion-title">Current Health Policies</div>
            <div class="suggestion-description">What are the latest maternal health policies and initiatives in India?</div>
        </div>
    </div>
    
    <!-- Controls section with toggle arrow -->
    <div class="controls-container">
        <button class="controls-toggle" id="controls-toggle" title="Toggle Settings">
            <svg class="toggle-arrow" viewBox="0 0 24 24">
                <path d="M7 14l5-5 5 5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        <div class="controls" id="controls-panel">
            <div class="control-group">
                <div class="control-item">
                    <div class="control-label">üìÑ Report Format</div>
                    <div class="control-select" id="format-select">
                        <span id="format-value">Executive Summary</span>
                        <svg class="icon" viewBox="0 0 16 16">
                            <path d="M1.79688 6L2.64062 6.85938L7.64062 11.8594L8 12.2031L8.35938 11.8594L13.3594 6.85938L14.2031 6H1.79688ZM4.21875 7H11.7812L8 10.7812L4.21875 7Z" fill="currentColor" opacity="0.5"/>
                        </svg>
                        <div class="dropdown-menu" id="format-dropdown">
                            <button class="dropdown-item" data-value="Executive Summary">Executive Summary</button>
                            <button class="dropdown-item" data-value="E-mail">E-mail</button>
                            <button class="dropdown-item" data-value="Bullet Points">Bullet Points</button>
                        </div>
                    </div>
                </div>
                <div class="control-item">
                    <div class="control-label">üåê Language</div>
                    <div class="control-select" id="language-select">
                        <span id="language-value">English</span>
                        <svg class="icon" viewBox="0 0 16 16">
                            <path d="M1.79688 6L2.64062 6.85938L7.64062 11.8594L8 12.2031L8.35938 11.8594L13.3594 6.85938L14.2031 6H1.79688ZM4.21875 7H11.7812L8 10.7812L4.21875 7Z" fill="currentColor" opacity="0.5"/>
                        </svg>
                        <div class="dropdown-menu" id="language-dropdown">
                            <button class="dropdown-item" data-value="English">English</button>
                            <button class="dropdown-item" data-value="Hindi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</button>
                            <button class="dropdown-item" data-value="Marathi">‡§Æ‡§∞‡§æ‡§†‡•Ä (Marathi)</button>
                            <button class="dropdown-item" data-value="Telugu">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</button>
                        </div>
                    </div>
                </div>
            </div>
            <button class="reset-btn" id="reset-btn">
                <span>Reset</span>
                <svg class="icon" viewBox="0 0 16 16">
                    <path d="M8 1.5C4.41602 1.5 1.5 4.41602 1.5 8C1.5 11.584 4.41602 14.5 8 14.5C11.584 14.5 14.5 11.584 14.5 8H13.5C13.5 11.043 11.043 13.5 8 13.5C4.95703 13.5 2.5 11.043 2.5 8C2.5 4.95703 4.95703 2.5 8 2.5C9.9375 2.5 11.6309 3.49219 12.6094 5H10V6H14V2H13V3.85938C11.8086 2.42188 10.0098 1.5 8 1.5Z" fill="#333333"/>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Input area as a separate element -->
    <div class="input-area">
        <textarea 
            class="input-textarea" 
            id="user-question"
            placeholder="üí¨ Ask your health care data analysis question..."
            disabled
        ></textarea>
        <div class="input-controls">
            <button class="mic-btn" id="mic-btn" title="Click to speak">
                <svg class="icon" viewBox="0 0 22 22">
                    <path d="M8.9375 2.75C8.18555 2.75 7.5625 3.37305 7.5625 4.125V12.375C7.5625 13.127 8.18555 13.75 8.9375 13.75H13.0625C13.8145 13.75 14.4375 13.127 14.4375 12.375V4.125C14.4375 3.37305 13.8145 2.75 13.0625 2.75H8.9375ZM8.9375 4.125H13.0625V12.375H8.9375V4.125ZM4.8125 9.625V12.375C4.8125 14.6443 6.66821 16.5 8.9375 16.5H10.3125V17.875H7.5625V19.25H14.4375V17.875H11.6875V16.5H13.0625C15.3318 16.5 17.1875 14.6443 17.1875 12.375V9.625H15.8125V12.375C15.8125 13.9004 14.5879 15.125 13.0625 15.125H8.9375C7.41211 15.125 6.1875 13.9004 6.1875 12.375V9.625H4.8125Z" fill="currentColor"/>
                </svg>
            </button>
            <button class="send-btn" id="send-btn" disabled>
                <svg class="icon icon-white" viewBox="0 0 20 20">
                    <path d="M10 2.55859L9.55078 2.98828L4.23828 8.30078L5.13672 9.19922L9.375 4.96094V17.5H10.625V4.96094L14.8633 9.19922L15.7617 8.30078L10.4492 2.98828L10 2.55859Z" fill="white"/>
                </svg>
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="web-search-config.js"></script>
    <script type="module" src="script.js"></script>
    <script>
        // Global variables for chat functionality
        let chatStarted = false;
        let messages = [];
        let currentFormat = 'Executive Summary';
        let currentLanguage = 'English';
        
        // Initial suggestions
        const initialSuggestions = [
            {
                title: "District MMR Ranking",
                description: "Rank the top 5 and bottom 5 districts by MMR"
            },
            {
                title: "Regional Anemia Comparison", 
                description: "Compare anemia prevalence in Lucknow, Gorakhpur, and Jhansi"
            },
            {
                title: "Current Health Policies",
                description: "What are the latest maternal health policies and initiatives in India?"
            }
        ];
        
        // Follow-up suggestions
        const followUpSuggestions = [
            {
                title: "Trend Analysis",
                description: "Show MMR trends over the past 5 years for these districts"
            },
            {
                title: "Contributing Factors", 
                description: "What factors contribute to high MMR in bottom-ranked districts?"
            },
            {
                title: "International Best Practices",
                description: "What are the latest global best practices for reducing maternal mortality?"
            }
        ];
        
        // DOM elements
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatArea = document.getElementById('chat-area');
        const userQuestion = document.getElementById('user-question');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const resetBtn = document.getElementById('reset-btn');
        const suggestionsContainer = document.getElementById('suggestions');
        const inputArea = document.querySelector('.input-area');
        
        // Initialize the interface
        function initializeInterface() {
            // Enable input when script.js loads
            if (typeof window.initializeApp === 'function') {
                window.initializeApp().then(() => {
                    userQuestion.disabled = false;
                    sendBtn.disabled = false;
                });
            } else {
                // Fallback: enable after a short delay
                setTimeout(() => {
                    userQuestion.disabled = false;
                    sendBtn.disabled = false;
                }, 1000);
            }
            
            setupEventListeners();
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Suggestion card clicks
            document.addEventListener('click', function(event) {
                if (event.target.closest('.suggestion-card')) {
                    const card = event.target.closest('.suggestion-card');
                    const description = card.dataset.description;
                    handleSuggestionClick(description);
                }
            });
            
            // Dropdown functionality
            setupDropdowns();
            
            // Send button click
            sendBtn.addEventListener('click', handleSendMessage);
            
            // Enter key press
            userQuestion.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });
            
            // Reset button
            resetBtn.addEventListener('click', handleReset);
            
            // Home button
            const homeBtn = document.getElementById('home-btn');
            homeBtn.addEventListener('click', function() {
                // Refresh the entire page for a fresh start
                window.location.reload();
            });
            
            // Mic button (placeholder for speech recognition)
            micBtn.addEventListener('click', function() {
                // This would integrate with your existing speech.js functionality
                if (typeof window.toggleSpeechRecognition === 'function') {
                    window.toggleSpeechRecognition();
                }
            });
        }
        
        // Handle suggestion click
        function handleSuggestionClick(description) {
            // Add loading state to suggestion cards
            const suggestionCards = document.querySelectorAll('.suggestion-card');
            suggestionCards.forEach(card => {
                card.classList.add('loading');
                card.disabled = true;
            });
            
            if (!chatStarted) {
                startChat(description);
            } else {
                userQuestion.value = description;
                handleSendMessage();
            }
        }
        
        // Start chat with first message
        function startChat(message) {
            chatStarted = true;
            
            // Hide welcome screen and show chat
            welcomeScreen.classList.add('hidden');
            chatArea.classList.add('active');
            
            // Add chat-active class to main-content for proper alignment
            const mainContent = document.querySelector('.main-content');
            mainContent.classList.add('chat-active');
            
            // Also add to body for global styling
            document.body.classList.add('chat-active');
            
            // Add user message
            addMessage(message, true);
            
            // Update suggestions to follow-up
            updateSuggestions(followUpSuggestions);
            
            // Adjust chat area padding to prevent overlap
            adjustChatPadding();
            
            // Send to your existing script.js logic
            userQuestion.value = message;
            
            // Trigger the existing send functionality
            if (typeof window.handleUserQuestion === 'function') {
                window.handleUserQuestion(message, currentFormat, currentLanguage);
            }
        }
        
        // Handle send message
        function handleSendMessage() {
            const message = userQuestion.value.trim();
            if (!message) return;
            
            if (!chatStarted) {
                startChat(message);
            } else {
                addMessage(message, true);
                
                // Trigger existing script.js logic
                if (typeof window.handleUserQuestion === 'function') {
                    window.handleUserQuestion(message, currentFormat, currentLanguage);
                }
            }
            
            userQuestion.value = '';
        }
        
        // Add message to chat
        function addMessage(message, isUser, timestamp) {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${isUser ? 'user' : 'ai'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            
            // For AI messages, parse markdown. For user messages, use plain text
            if (isUser) {
                messageText.textContent = message;
            } else {
                messageText.innerHTML = typeof marked !== 'undefined' ? marked.parse(message) : message;
            }
            
            bubble.appendChild(messageText);
            
            if (timestamp) {
                const timestampElement = document.createElement('div');
                timestampElement.className = 'message-timestamp';
                timestampElement.textContent = timestamp;
                bubble.appendChild(timestampElement);
            }
            
            messageElement.appendChild(bubble);
            chatArea.appendChild(messageElement);
            
            // Scroll to bottom
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        
        // Adjust chat area padding to prevent overlap with bottom section
        function adjustChatPadding() {
            setTimeout(() => {
                const bottomSection = document.querySelector('.bottom-section');
                const chatArea = document.querySelector('.chat-area');
                
                if (bottomSection && chatArea) {
                    const bottomSectionHeight = bottomSection.offsetHeight;
                    const viewportHeight = window.innerHeight;
                    const bottomSectionFromBottom = viewportHeight - bottomSection.getBoundingClientRect().top;
                    const newPadding = Math.max(200, bottomSectionFromBottom + 40);
                    chatArea.style.paddingBottom = newPadding + 'px';
                    
                    // Also ensure scroll behavior works properly
                    chatArea.scrollTop = chatArea.scrollHeight;
                }
            }, 100);
        }
        
        // Update suggestions (make it global for script.js access)
        window.updateSuggestions = function updateSuggestions(newSuggestions) {
            if (!chatStarted) {
                // Welcome screen suggestions - use original card layout
                suggestionsContainer.innerHTML = '';
                newSuggestions.forEach(suggestion => {
                    const card = document.createElement('div');
                    card.className = 'suggestion-card';
                    card.dataset.description = suggestion.description;
                    
                    card.innerHTML = `
                        <div class="suggestion-title">${suggestion.title}</div>
                        <div class="suggestion-description">${suggestion.description}</div>
                    `;
                    
                    suggestionsContainer.appendChild(card);
                });
            } else {
                // Chat active - add follow-up questions directly to chat area
                addFollowUpQuestions(newSuggestions);
                // Clear the bottom suggestions since they're now in chat
                suggestionsContainer.innerHTML = '';
            }
        }
        
        // Add follow-up questions to chat area
        function addFollowUpQuestions(suggestions) {
            if (!suggestions || suggestions.length === 0) return;
            
            const followUpContainer = document.createElement('div');
            followUpContainer.className = 'chat-followup-questions';
            
            const title = document.createElement('div');
            title.className = 'chat-followup-title';
            title.textContent = 'Continue exploring';
            followUpContainer.appendChild(title);
            
            suggestions.forEach(suggestion => {
                const questionBtn = document.createElement('button');
                questionBtn.className = 'chat-followup-question';
                questionBtn.textContent = suggestion.description;
                questionBtn.dataset.description = suggestion.description;
                
                questionBtn.addEventListener('click', function() {
                    handleSuggestionClick(suggestion.description);
                });
                
                followUpContainer.appendChild(questionBtn);
            });
            
            chatArea.appendChild(followUpContainer);
            chatArea.scrollTop = chatArea.scrollHeight;
        }
        
        // Handle reset
        function handleReset() {
            chatStarted = false;
            messages = [];
            
            // Show welcome screen and hide chat
            welcomeScreen.classList.remove('hidden');
            chatArea.classList.remove('active');
            chatArea.innerHTML = '';
            
            // Remove chat-active class from main-content
            const mainContent = document.querySelector('.main-content');
            mainContent.classList.remove('chat-active');
            
            // Also remove from body
            document.body.classList.remove('chat-active');
            
            // Reset suggestions
            updateSuggestions(initialSuggestions);
            
            // Clear input
            userQuestion.value = '';
            
            // Call existing reset functionality
            if (typeof window.resetAnalysis === 'function') {
                window.resetAnalysis();
            }
        }
        
        // Public functions for script.js integration
        window.addAIMessage = function(message, timestamp) {
            addMessage(message, false, timestamp);
        };
        
        window.setLoadingState = function(loading) {
            if (loading) {
                sendBtn.classList.add('loading');
                sendBtn.disabled = true;
                inputArea.classList.add('loading');
                userQuestion.disabled = true;
            } else {
                sendBtn.classList.remove('loading');
                sendBtn.disabled = false;
                inputArea.classList.remove('loading');
                userQuestion.disabled = false;
                
                // Remove loading state from suggestion cards
                const suggestionCards = document.querySelectorAll('.suggestion-card');
                suggestionCards.forEach(card => {
                    card.classList.remove('loading');
                    card.disabled = false;
                });
            }
        };

        // File processing indicators
        window.showFileProcessing = function() {
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'loading-indicator';
            loadingIndicator.id = 'file-processing-indicator';
            loadingIndicator.innerHTML = `
                <div class="loading-spinner"></div>
                <div class="loading-text">Processing data files...</div>
            `;
            chatArea.appendChild(loadingIndicator);
            chatArea.scrollTop = chatArea.scrollHeight;
        };

        window.hideFileProcessing = function() {
            const indicator = document.getElementById('file-processing-indicator');
            if (indicator) {
                indicator.remove();
            }
        };

        window.updateFileProcessing = function(text) {
            const indicator = document.getElementById('file-processing-indicator');
            if (indicator) {
                const textElement = indicator.querySelector('.loading-text');
                if (textElement) {
                    textElement.textContent = text;
                }
            }
        };

        // Streaming indicators
        window.showStreaming = function() {
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'loading-indicator';
            loadingIndicator.id = 'streaming-indicator';
            loadingIndicator.innerHTML = `
                <div class="loading-spinner"></div>
                <div class="loading-text">Generating response...</div>
            `;
            chatArea.appendChild(loadingIndicator);
            chatArea.scrollTop = chatArea.scrollHeight;
        };

        window.hideStreaming = function() {
            const indicator = document.getElementById('streaming-indicator');
            if (indicator) {
                indicator.remove();
            }
        };

        // Streaming message functions removed - using loading indicator instead
        
        // Setup dropdown functionality
        function setupDropdowns() {
            const formatSelect = document.getElementById('format-select');
            const languageSelect = document.getElementById('language-select');
            const formatDropdown = document.getElementById('format-dropdown');
            const languageDropdown = document.getElementById('language-dropdown');
            
            // Format dropdown
            formatSelect.addEventListener('click', function(e) {
                e.stopPropagation();
                // Close language dropdown if open
                languageDropdown.classList.remove('show');
                // Toggle format dropdown
                formatDropdown.classList.toggle('show');
            });
            
            // Language dropdown
            languageSelect.addEventListener('click', function(e) {
                e.stopPropagation();
                // Close format dropdown if open
                formatDropdown.classList.remove('show');
                // Toggle language dropdown
                languageDropdown.classList.toggle('show');
            });
            
            // Handle format selection
            formatDropdown.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent event bubbling
                if (e.target.classList.contains('dropdown-item')) {
                    const value = e.target.dataset.value;
                    const formatValue = document.getElementById('format-value');
                    formatValue.textContent = value;
                    currentFormat = value;
                    formatDropdown.classList.remove('show');
                }
            });
            
            // Handle language selection
            languageDropdown.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent event bubbling
                if (e.target.classList.contains('dropdown-item')) {
                    const value = e.target.dataset.value;
                    const languageValue = document.getElementById('language-value');
                    languageValue.textContent = value;
                    currentLanguage = value;
                    languageDropdown.classList.remove('show');
                }
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function() {
                formatDropdown.classList.remove('show');
                languageDropdown.classList.remove('show');
            });
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeInterface);
    </script>
</body>
</html>